<!DOCTYPE html>
<html lang="zh-TW">
<!--
è³ªæ•¸èˆ‡åˆæ•¸éŠæˆ² - ä½¿ç”¨ Supabase ä½œç‚ºå¾Œç«¯

Supabase è¨­ç½®èªªæ˜ï¼š
1. å‰µå»ºä¸€å€‹ Supabase å°ˆæ¡ˆ

2. åœ¨ SQL ç·¨è¼¯å™¨ä¸­å‰µå»º history è¡¨ï¼š
   CREATE TABLE history (
     id UUID PRIMARY KEY,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     name VARCHAR,
     score INT4
   );

3. è¨­ç½® Row Level Security (RLS) æ”¿ç­–ä»¥å…è¨±åŒ¿åç”¨æˆ¶æ“ä½œï¼š
   a) å•Ÿç”¨ RLSï¼š
      ALTER TABLE history ENABLE ROW LEVEL SECURITY;
   
   b) å‰µå»ºå…è¨±è®€å–çš„æ”¿ç­–ï¼š
      CREATE POLICY "Allow public read access" ON history
      FOR SELECT USING (true);
   
   c) å‰µå»ºå…è¨±æ’å…¥/æ›´æ–°çš„æ”¿ç­–ï¼š
      CREATE POLICY "Allow public insert/update access" ON history
      FOR ALL USING (true) WITH CHECK (true);

4. åœ¨ JavaScript ä¸­çš„ URL å’Œ ANON_KEY å·²è¨­ç½®å®Œæˆ

æ³¨æ„ï¼šä»¥ä¸Š RLS æ”¿ç­–å…è¨±æ‰€æœ‰ç”¨æˆ¶è®€å¯«ï¼Œé©åˆéŠæˆ²æ¼”ç¤ºã€‚
åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´åš´æ ¼çš„å®‰å…¨æ”¿ç­–ã€‚
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ªæ•¸èˆ‡åˆæ•¸éŠæˆ²</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a game-like feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 100%;
            transition: all 0.3s ease-in-out;
            margin-bottom: 20px;
        }

        .game-container:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .number-display {
            font-size: 8rem;
            font-weight: bold;
            color: #334155;
            /* Slate-600 */
            margin: 20px 0;
            user-select: none;
        }

        .message-display {
            min-height: 40px;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 1.25rem;
            color: #64748b;
            /* Slate-500 */
            margin-top: 20px;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
            /* Amber-500 */
        }

        .correct {
            color: #16a34a;
            /* Green-600 */
        }

        .wrong {
            color: #dc2626;
            /* Red-600 */
        }

        .hidden {
            display: none;
        }

        @media (max-width: 640px) {
            .number-display {
                font-size: 5rem;
            }
        }
    </style>
</head>

<body>

    <div class="game-container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">è³ªæ•¸åˆæ•¸éŠæˆ²</h1>
        <p class="text-lg text-gray-600 mb-4">è«‹åœ¨45ç§’å…§ç›¡å¯èƒ½åœ°ç­”å°æ›´å¤šé¡Œç›®</p>

        <!-- Initial screen for user name input -->
        <div id="start-screen" class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">è¼¸å…¥æ‚¨çš„åç¨±</h2>
            <input type="text" id="player-name-input" placeholder="æ‚¨çš„åç¨±"
                class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
            <button id="start-btn"
                class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg mt-6 hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                é–‹å§‹éŠæˆ²
            </button>
        </div>

        <!-- Game screen (initially hidden) -->
        <div id="game-screen" class="hidden">
            <!-- Timer display -->
            <div id="timer-display" class="timer-display"></div>

            <!-- The number to be guessed -->
            <div id="number-display" class="number-display select-none">--</div>

            <!-- Message for feedback -->
            <div id="message-display" class="message-display"></div>
            <div id="explanation-display" class="text-gray-600 mt-4 text-base font-normal"></div>

            <!-- Buttons for user input -->
            <div class="flex justify-center gap-4 mt-8">
                <button id="prime-btn"
                    class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:bg-indigo-400">
                    è³ªæ•¸
                </button>
                <button id="composite-btn"
                    class="bg-sky-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-sky-700 transition duration-300 transform hover:scale-105 disabled:bg-sky-400">
                    åˆæ•¸
                </button>
            </div>

            <!-- Restart button -->
            <button id="restart-btn"
                class="hidden bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-lg mt-4 hover:bg-gray-600 transition duration-300 transform hover:scale-105">
                é‡æ–°é–‹å§‹
            </button>

            <!-- Score display -->
            <div class="score-display">
                åˆ†æ•¸ï¼š<span id="score-count">0</span> / <span id="question-count">0</span>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="mt-8 pt-8 border-t border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ† æ’è¡Œæ¦œ</h2>
                <div id="leaderboard-loading" class="hidden">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600"></div>
                </div>
            </div>
            <div id="leaderboard" class="space-y-2 text-left max-h-80 overflow-y-auto">
                <!-- Leaderboard items will be inserted here by JavaScript -->
            </div>
            <div class="mt-4 text-sm text-gray-500 break-words">
                æ‚¨çš„ä½¿ç”¨è€…IDï¼š<span id="user-id">è®€å–ä¸­...</span>
            </div>
        </div>
    </div>

    <script type="module">
        // Supabase imports
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

        // UUID generation function
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Get all necessary HTML elements
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const playerNameInput = document.getElementById('player-name-input');
        const startBtn = document.getElementById('start-btn');
        const numberDisplay = document.getElementById('number-display');
        const messageDisplay = document.getElementById('message-display');
        const explanationDisplay = document.getElementById('explanation-display');
        const scoreCountDisplay = document.getElementById('score-count');
        const questionCountDisplay = document.getElementById('question-count');
        const primeBtn = document.getElementById('prime-btn');
        const compositeBtn = document.getElementById('composite-btn');
        const timerDisplay = document.getElementById('timer-display');
        const leaderboardDiv = document.getElementById('leaderboard');
        const leaderboardLoading = document.getElementById('leaderboard-loading');
        const userIdDisplay = document.getElementById('user-id');
        const restartBtn = document.getElementById('restart-btn');

        // Game state variables
        let currentNumber;
        let score = 0;
        let questionCount = 0;
        let totalTimerInterval;
        const TOTAL_TIME = 45; // Use a constant for the game time
        let totalTime = TOTAL_TIME;
        let isGameRunning = false;
        let isSupabaseReady = false;
        let playerName = '';

        // Supabase variables
        let userId;
        let supabase;

        // Game Logic Functions (Moved to the top to ensure they are defined before being called)
        const isPrime = num => {
            if (num <= 1) return false;
            for (let i = 2; i <= Math.sqrt(num); i++) {
                if (num % i === 0) return false;
            }
            return true;
        };

        const getFactors = (num) => {
            const factors = [];
            for (let i = 1; i <= num; i++) {
                if (num % i === 0) {
                    factors.push(i);
                }
            }
            return factors;
        };

        const startTotalTimer = () => {
            clearInterval(totalTimerInterval);
            timerDisplay.textContent = `å‰©é¤˜æ™‚é–“: ${totalTime} ç§’`;
            totalTimerInterval = setInterval(() => {
                if (isGameRunning) {
                    totalTime--;
                    timerDisplay.textContent = `å‰©é¤˜æ™‚é–“: ${totalTime} ç§’`;
                    if (totalTime <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        };

        const endGame = () => {
            isGameRunning = false;
            clearInterval(totalTimerInterval);
            primeBtn.disabled = true;
            compositeBtn.disabled = true;
            numberDisplay.textContent = '--';
            messageDisplay.textContent = 'éŠæˆ²çµæŸï¼';
            messageDisplay.classList.remove('correct', 'wrong');
            explanationDisplay.textContent = `æ‚¨ç¸½å…±ç­”å°äº† ${score} é¡Œï¼`;
            restartBtn.classList.remove('hidden');
            saveScore();
        }

        const generateNumber = () => {
            if (!isGameRunning) return;

            primeBtn.disabled = false;
            compositeBtn.disabled = false;
            messageDisplay.textContent = '';
            explanationDisplay.textContent = '';
            messageDisplay.className = 'message-display';
            numberDisplay.textContent = '--';

            // Generate a random number between 2 and 100 (inclusive)
            currentNumber = Math.floor(Math.random() * 99) + 2;
            numberDisplay.textContent = currentNumber;
        };

        const checkAnswer = (userIsPrime) => {
            if (!isGameRunning) return;

            primeBtn.disabled = true;
            compositeBtn.disabled = true;

            const isCurrentNumberPrime = isPrime(currentNumber);
            const isAnswerCorrect = (userIsPrime !== null) &&
                ((userIsPrime && isCurrentNumberPrime) || (!userIsPrime && !isCurrentNumberPrime));

            questionCount++;
            if (isAnswerCorrect) {
                score++;
                messageDisplay.textContent = 'ç­”å°äº†ï¼';
                messageDisplay.classList.add('correct');
            } else {
                messageDisplay.textContent = 'ç­”éŒ¯äº†ï¼';
                messageDisplay.classList.add('wrong');

                // Show detailed explanation for wrong answers
                const factors = getFactors(currentNumber);
                explanationDisplay.textContent = `å› ç‚º ${currentNumber} çš„å› æ•¸æœ‰ï¼š${factors.join('ã€')}`;
            }

            scoreCountDisplay.textContent = score;
            questionCountDisplay.textContent = questionCount;

            // Automatically move to the next question after a short delay
            setTimeout(() => {
                if (isGameRunning) generateNumber();
            }, 1500);
        };

        const startGame = () => {
            score = 0;
            questionCount = 0;
            totalTime = TOTAL_TIME;
            isGameRunning = true;
            restartBtn.classList.add('hidden');
            scoreCountDisplay.textContent = score;
            questionCountDisplay.textContent = questionCount;
            startTotalTimer();
            generateNumber();
        };

        const handleStartGame = () => {
            playerName = playerNameInput.value.trim() || `ä½¿ç”¨è€… ${userId.substring(0, 4)}`;
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            startGame();
        };


        // Supabase Functions
        const saveScore = async () => {
            if (!isSupabaseReady || !userId) {
                console.error("Supabase not ready, cannot save score.");
                return;
            }

            try {
                // Check if user already has a score in the database
                const { data: existingData, error: selectError } = await supabase
                    .from('history')
                    .select('score')
                    .eq('id', userId)
                    .maybeSingle(); // ä½¿ç”¨ maybeSingle è€Œä¸æ˜¯ single ä¾†é¿å… PGRST116 éŒ¯èª¤

                // è™•ç†æŸ¥è©¢éŒ¯èª¤ï¼ˆä½† PGRST116 ä¸æ˜¯çœŸæ­£çš„éŒ¯èª¤ï¼‰
                if (selectError) {
                    console.error("Error checking existing score:", selectError);
                    return;
                }

                const currentHighScore = existingData ? existingData.score : 0;

                // Only save score if it's a new high score
                if (score > currentHighScore) {
                    const { error: upsertError } = await supabase
                        .from('history')
                        .upsert({
                            id: userId,
                            name: playerName,
                            score: score
                            // ç§»é™¤ created_atï¼Œè®“è³‡æ–™åº«è‡ªå‹•è¨­å®š
                        });

                    if (upsertError) {
                        console.error("Error saving score:", upsertError);
                        console.error("é€™å¯èƒ½æ˜¯å› ç‚º Row Level Security (RLS) æ”¿ç­–é˜»æ­¢äº†æ“ä½œ");
                        console.error("è«‹æª¢æŸ¥ Supabase çš„ RLS è¨­å®š");
                    } else {
                        console.log("Score saved successfully!");
                        // é¡¯ç¤ºæˆåŠŸå‹•ç•«
                        showScoreSavedAnimation();
                        // å„²å­˜æˆåŠŸå¾Œç«‹å³æ›´æ–°æ’è¡Œæ¦œ
                        setTimeout(() => {
                            loadLeaderboard(true);
                        }, 500); // å»¶é² 500ms ç¢ºä¿è³‡æ–™åº«å·²æ›´æ–°
                    }
                }
            } catch (e) {
                console.error("Error saving score:", e);
            }
        };

        const loadLeaderboard = async (showLoading = true) => {
            try {
                // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
                if (showLoading) {
                    leaderboardLoading.classList.remove('hidden');
                }

                // Get top 10 scores from Supabase
                const { data: scores, error } = await supabase
                    .from('history')
                    .select('id, name, score, created_at')
                    .order('score', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error("Error loading leaderboard:", error);
                    leaderboardDiv.innerHTML = '<p class="text-red-500">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p>';
                    return;
                }

                // Render leaderboard
                leaderboardDiv.innerHTML = '';
                if (!scores || scores.length === 0) {
                    leaderboardDiv.innerHTML = '<p class="text-gray-500 text-center py-4">ğŸ® é‚„æ²’æœ‰ç©å®¶è¨˜éŒ„ï¼Œæˆç‚ºç¬¬ä¸€åå§ï¼</p>';
                    return;
                }

                scores.forEach((item, index) => {
                    const scoreItem = document.createElement('div');
                    const isCurrentUser = item.id === userId;
                    const isTopThree = index < 3;
                    
                    // ç²å–æ’ååœ–ç¤º
                    const getRankIcon = (rank) => {
                        switch(rank) {
                            case 0: return 'ğŸ¥‡';
                            case 1: return 'ğŸ¥ˆ';
                            case 2: return 'ğŸ¥‰';
                            default: return `#${rank + 1}`;
                        }
                    };

                    // è¨­å®šæ¨£å¼é¡åˆ¥
                    let baseClass = 'flex justify-between items-center p-3 rounded-lg transition-all duration-200 border';
                    if (isCurrentUser) {
                        baseClass += ' bg-gradient-to-r from-indigo-100 to-purple-100 border-indigo-300 font-bold shadow-md';
                    } else if (isTopThree) {
                        baseClass += ' bg-gradient-to-r from-yellow-50 to-orange-50 border-yellow-200';
                    } else {
                        baseClass += ' bg-gray-50 border-gray-200 hover:bg-gray-100';
                    }
                    
                    scoreItem.className = baseClass;

                    // Display the player's name if available, otherwise use a shortened user ID
                    const displayName = item.name || `ç©å®¶${item.id.substring(0, 4)}`;
                    const timeAgo = getTimeAgo(new Date(item.created_at));

                    scoreItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="text-lg font-bold ${isTopThree ? 'text-xl' : ''}">${getRankIcon(index)}</span>
                            <div>
                                <div class="font-medium ${isCurrentUser ? 'text-indigo-700' : 'text-gray-800'}">${displayName}</div>
                                <div class="text-xs text-gray-500">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${isCurrentUser ? 'text-indigo-600' : 'text-gray-700'}">${item.score} åˆ†</div>
                            ${isCurrentUser ? '<div class="text-xs text-indigo-500">æ‚¨çš„æœ€ä½³æˆç¸¾</div>' : ''}
                        </div>
                    `;
                    leaderboardDiv.appendChild(scoreItem);
                });
            } catch (e) {
                console.error("Error loading leaderboard:", e);
                leaderboardDiv.innerHTML = '<p class="text-red-500 text-center py-4">âš ï¸ è¼‰å…¥æ’è¡Œæ¦œæ™‚ç™¼ç”ŸéŒ¯èª¤</p>';
            } finally {
                // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
                if (showLoading) {
                    leaderboardLoading.classList.add('hidden');
                }
            }
        };

        // æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸
        const getTimeAgo = (date) => {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'å‰›å‰›';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} åˆ†é˜å‰`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} å°æ™‚å‰`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} å¤©å‰`;
            return date.toLocaleDateString('zh-TW');
        };

        // Set up real-time leaderboard updates
        const setupRealtimeLeaderboard = () => {
            if (!supabase) return;
            
            // Subscribe to changes in the history table
            const subscription = supabase
                .channel('history_changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'history' 
                    }, 
                    (payload) => {
                        console.log('Database change detected:', payload);
                        // ä½¿ç”¨è¼ƒçŸ­çš„å»¶é²ä¾†å³æ™‚æ›´æ–°æ’è¡Œæ¦œ
                        setTimeout(() => {
                            loadLeaderboard(false); // ä¸é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œå› ç‚ºæ˜¯èƒŒæ™¯æ›´æ–°
                        }, 200);
                    }
                )
                .subscribe();

            return subscription;
        };

        // æ·»åŠ è¦–è¦ºæ•ˆæœï¼šç•¶åˆ†æ•¸è¢«å„²å­˜æ™‚é¡¯ç¤ºå‹•ç•«
        const showScoreSavedAnimation = () => {
            // å‰µå»ºä¸€å€‹è‡¨æ™‚çš„æˆåŠŸæç¤º
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 z-50';
            successMsg.innerHTML = 'âœ… åˆ†æ•¸å·²å„²å­˜ï¼';
            document.body.appendChild(successMsg);
            
            // 3ç§’å¾Œç§»é™¤æç¤º
            setTimeout(() => {
                successMsg.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(successMsg);
                }, 300);
            }, 3000);
        };

        // Initialize Supabase
        const initializeSupabase = async () => {
            try {
                // Initialize Supabase client
                // è«‹å°‡ä»¥ä¸‹çš„ URL å’Œ ANON_KEY æ›¿æ›ç‚ºæ‚¨çš„ Supabase å°ˆæ¡ˆè³‡è¨Š
                const SUPABASE_URL = 'https://dptehguqgkttzykxwmha.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdGVoZ3VxZ2t0dHp5a3h3bWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Nzc5NTMsImV4cCI6MjA3MjU1Mzk1M30.RuqqBRQBXwBtW7q4t1ZwGVipffgpTzNYt4Tw22npQTg';
                
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Generate a random UUID for the user
                userId = generateUUID();
                
                // Store userId in localStorage to persist across sessions
                const storedUserId = localStorage.getItem('gameUserId');
                if (storedUserId) {
                    userId = storedUserId;
                        } else {
                    localStorage.setItem('gameUserId', userId);
                    }

                    if (userId) {
                        userIdDisplay.textContent = userId;
                    isSupabaseReady = true;
                    
                    // Load leaderboard and set up real-time updates
                    await loadLeaderboard();
                    setupRealtimeLeaderboard();
                    } else {
                    console.error("User ID generation failed.");
                    }
            } catch (e) {
                console.error("Supabase initialization failed:", e);
            }
        };

        // Add event listeners
        startBtn.addEventListener('click', handleStartGame);
        primeBtn.addEventListener('click', () => checkAnswer(true));
        compositeBtn.addEventListener('click', () => checkAnswer(false));
        restartBtn.addEventListener('click', () => {
            totalTime = TOTAL_TIME;
            startGame();
        });

        // Start the game by initializing Supabase
        window.onload = initializeSupabase;
    </script>

</body>

</html>